/*
 * ChaCha20 tester.
 * Copyright (C) 2014 Ketmar Dark // Invisible Vector (ketmar@ketmar.no-ip.org)
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, version 3 of the License ONLY.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * Get a copy of the GNU GPL from <http://www.gnu.org/licenses/>.
 */
// test vectors from RFC-6229
import std.stdio, std.conv, std.range, std.array, std.algorithm;

import iv.stc.chacha8;


uint count = 0;

void test (const(void)[] key, const(void)[] iv, const(void)[] ks, const(uint)[] xst) {
  auto bkey = cast(const(ubyte)[])key;
  auto biv = cast(const(ubyte)[])iv;
  auto bks = cast(const(ubyte)[])ks;
  auto ctx = ChaCha8(bkey, biv);
  {
    auto st = ctx.getState;
    if (st[] != xst[]) {
      import std.stdio;
      writeln("xst.length=", xst.length, "; st.length=", st.length);
      foreach (immutable idx; 0..16) {
        writefln("idx=%s; xst=0x%08x, st=0x%08x", idx, xst[idx], st[idx]);
        assert(xst[idx] == st[idx]);
      }
    }
  }

  foreach (immutable idx, ubyte v; bks) {
    if (ctx.front != v) {
      import std.string : format;
      assert(0, "failed! idx=%s; v=%02X %02X".format(idx, v, ctx.front));
    }
    ctx.popFront();
  }

  //writeln("test ", count, " passed");
  ++count;
}


void main () {
  writeln("testing ChaCha8...");

  { //0
    immutable[] key = x"00000000000000000000000000000000";
    immutable[] nonce = x"0000000000000000";
    immutable[] ks = x"E28A5FA4A67F8C5DEFED3E6FB7303486AA8427D31419A729572D777953491120B64AB8E72B8DEB85CD6AEA7CB6089A101824BEEB08814A428AAB1FA2C816081B8A26AF448A1BA906368FD8C83831C18CEC8CED811A028E675B8D2BE8FCE081165CEAE9F1D1B7A975497749480569CEB83DE6A0A587D4984F19925F5D338E430D";
    immutable uint[] st = [0x61707865,0x3120646e,0x79622d36,0x6b206574,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,];
    test(key[], nonce[], ks[], st[]);
  }
  { //1
    immutable[] key = x"0000000000000000000000000000000000000000000000000000000000000000";
    immutable[] nonce = x"0000000000000000";
    immutable[] ks = x"3E00EF2F895F40D67F5BB8E81F09A5A12C840EC3CE9A7F3B181BE188EF711A1E984CE172B9216F419F445367456D5619314A42A3DA86B001387BFDB80E0CFE42D2AEFA0DEAA5C151BF0ADB6C01F2A5ADC0FD581259F9A2AADCF20F8FD566A26B5032EC38BBC5DA98EE0C6F568B872A65A08ABF251DEB21BB4B56E5D8821E68AA";
    immutable uint[] st = [0x61707865,0x3320646e,0x79622d32,0x6b206574,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,];
    test(key[], nonce[], ks[], st[]);
  }
  { //2
    immutable[] key = x"01000000000000000000000000000000";
    immutable[] nonce = x"0000000000000000";
    immutable[] ks = x"03A7669888605A0765E8357475E58673F94FC8161DA76C2A3AA2F3CAF9FE5449E0FCF38EB882656AF83D430D410927D55C972AC4C92AB9DA3713E19F761EAA147138C25C8A7CE3D5E7546746FFD2E3515CE6A4B1B2D3F380138668ED39FA92F8A1AEE36258E05FAE6F566673511765FDB59E05163D55A708C5F9BC45045124CB";
    immutable uint[] st = [0x61707865,0x3120646e,0x79622d36,0x6b206574,0x00000001,0x00000000,0x00000000,0x00000000,0x00000001,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,];
    test(key[], nonce[], ks[], st[]);
  }
  { //3
    immutable[] key = x"0100000000000000000000000000000000000000000000000000000000000000";
    immutable[] nonce = x"0000000000000000";
    immutable[] ks = x"CF5EE9A0494AA9613E05D5ED725B804B12F4A465EE635ACC3A311DE8740489EA289D04F43C7518DB56EB4433E498A1238CD8464D3763DDBB9222EE3BD8FAE3C8B4355A7D93DD8867089EE643558B95754EFA2BD1A8A1E2D75BCDB32015542638291941FEB49965587C4FDFE219CF0EC132A6CD4DC067392E67982FE53278C0B4";
    immutable uint[] st = [0x61707865,0x3320646e,0x79622d32,0x6b206574,0x00000001,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,];
    test(key[], nonce[], ks[], st[]);
  }
  { //4
    immutable[] key = x"00000000000000000000000000000000";
    immutable[] nonce = x"0100000000000000";
    immutable[] ks = x"25F5BEC6683916FF44BCCD12D102E692176663F4CAC53E719509CA74B6B2EEC85DA4236FB29902012ADC8F0D86C8187D25CD1C486966930D0204C4EE88A6AB355A6C9976C7BC6E78BAF3108C5364EF42B93B35D2694D2DDF72A4FC7ECDB968FCFE16BEDB8D48102FB54F1CE3636E914C0E2DADC7CAA2AB1929733A9263325E72";
    immutable uint[] st = [0x61707865,0x3120646e,0x79622d36,0x6b206574,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000001,0x00000000,];
    test(key[], nonce[], ks[], st[]);
  }
  { //5
    immutable[] key = x"0000000000000000000000000000000000000000000000000000000000000000";
    immutable[] nonce = x"0100000000000000";
    immutable[] ks = x"2B8F4BB3798306CA5130D47C4F8D4ED13AA0EDCCC1BE6942090FAEECA0D7599B7FF0FE616BB25AA0153AD6FDC88B954903C22426D478B97B22B8F9B1DB00CF06470BDFFBC488A8B7C701EBF4061D75C5969186497C95367809AFA80BD843B040A79ABC6E73A91757F1DB73C8EACFA543B38F289D065AB2F3032D377B8C37FE46";
    immutable uint[] st = [0x61707865,0x3320646e,0x79622d32,0x6b206574,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000001,0x00000000,];
    test(key[], nonce[], ks[], st[]);
  }
  { //6
    immutable[] key = x"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF";
    immutable[] nonce = x"FFFFFFFFFFFFFFFF";
    immutable[] ks = x"2204D5B81CE662193E00966034F91302F14A3FB047F58B6E6EF0D721132304163E0FB640D76FF9C3B9CD99996E6E38FAD13F0E31C82244D33ABBC1B11E8BF12D9A81D78E9E56604DDFAE136921F51C9D81AE15119DB8E756DD28024493EE571D363AE4BBCD6E7D300F99D2673AEB92CCFC6E43A38DC31BACD66B28F17B22B28A";
    immutable uint[] st = [0x61707865,0x3120646e,0x79622d36,0x6b206574,0xffffffff,0xffffffff,0xffffffff,0xffffffff,0xffffffff,0xffffffff,0xffffffff,0xffffffff,0x00000000,0x00000000,0xffffffff,0xffffffff,];
    test(key[], nonce[], ks[], st[]);
  }
  { //7
    immutable[] key = x"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF";
    immutable[] nonce = x"FFFFFFFFFFFFFFFF";
    immutable[] ks = x"E163BBF8C9A739D18925EE8362DAD2CDC973DF05225AFB2AA26396F2A9849A4A445E0547D31C1623C537DF4BA85C70A9884A35BCBF3DFAB077E98B0F68135F5481D4933F8B322AC0CD762C27235CE2B31534E0244A9A2F1FD5E94498D47FF108790C009CF9E1A348032A7694CB28024CD96D3498361EDB1785AF752D187AB54B";
    immutable uint[] st = [0x61707865,0x3320646e,0x79622d32,0x6b206574,0xffffffff,0xffffffff,0xffffffff,0xffffffff,0xffffffff,0xffffffff,0xffffffff,0xffffffff,0x00000000,0x00000000,0xffffffff,0xffffffff,];
    test(key[], nonce[], ks[], st[]);
  }
  { //8
    immutable[] key = x"55555555555555555555555555555555";
    immutable[] nonce = x"5555555555555555";
    immutable[] ks = x"F0A23BC36270E18ED0691DC384374B9B2C5CB60110A03F56FA48A9FBBAD961AA6BAB4D892E96261B6F1A0919514AE56F86E066E17C71A4176AC684AF1C931996950F754E728BD061D176ECF571C62A5EA5C776697B3193D3EA94CF17D7F0A14E504859D1A67C248AB298BE3BB7EDED3A23F61B6C5BD1A5A4CFC84BFC3D295AC5";
    immutable uint[] st = [0x61707865,0x3120646e,0x79622d36,0x6b206574,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x00000000,0x00000000,0x55555555,0x55555555,];
    test(key[], nonce[], ks[], st[]);
  }
  { //9
    immutable[] key = x"5555555555555555555555555555555555555555555555555555555555555555";
    immutable[] nonce = x"5555555555555555";
    immutable[] ks = x"7CB78214E4D3465B6DC62CF7A1538C88996952B4FB72CB6105F1243CE3442E2975A59EBCD2B2A598290D7538491FE65BDBFEFD060D88798120A70D049DC2677DD48FF5A2513E497A5D54802D7484C4F1083944D8D0D14D6482CE09F7E5EBF20B29807D62C31874D02F5D3CC85381A745ECBC60525205E300A76961BFE51AC07C";
    immutable uint[] st = [0x61707865,0x3320646e,0x79622d32,0x6b206574,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x00000000,0x00000000,0x55555555,0x55555555,];
    test(key[], nonce[], ks[], st[]);
  }
  { //10
    immutable[] key = x"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";
    immutable[] nonce = x"AAAAAAAAAAAAAAAA";
    immutable[] ks = x"312D95C0BC38EFF4942DB2D50BDC500A30641EF7132DB1A8AE838B3BEA3A7AB03815D7A4CC09DBF5882A3433D743ACED48136EBAB73299506855C0F5437A36C6EF5AD3D6A4F6C35D9D66C2E34005B91BBBE3099E135A00CE2F700745BE6253195824D4B19F69731B6177E624358C7977E67552F519B470E3F7A8EC965DC3BEDA";
    immutable uint[] st = [0x61707865,0x3120646e,0x79622d36,0x6b206574,0xaaaaaaaa,0xaaaaaaaa,0xaaaaaaaa,0xaaaaaaaa,0xaaaaaaaa,0xaaaaaaaa,0xaaaaaaaa,0xaaaaaaaa,0x00000000,0x00000000,0xaaaaaaaa,0xaaaaaaaa,];
    test(key[], nonce[], ks[], st[]);
  }
  { //11
    immutable[] key = x"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";
    immutable[] nonce = x"AAAAAAAAAAAAAAAA";
    immutable[] ks = x"40F9AB86C8F9A1A0CDC05A75E5531B612D71EF7F0CF9E387DF6ED6972F0AAE21311AA581F816C90E8A99DE990B6B95AAC92450F4E112712667B804C99E9C6EDAF8D144F560C8C0EA36880D3B77874C9A9103D147F6DED386284801A4EE158E5EA4F9C093FC55FD344C33349DC5B699E21DC83B4296F92EE3ECABF3D51F95FE3F";
    immutable uint[] st = [0x61707865,0x3320646e,0x79622d32,0x6b206574,0xaaaaaaaa,0xaaaaaaaa,0xaaaaaaaa,0xaaaaaaaa,0xaaaaaaaa,0xaaaaaaaa,0xaaaaaaaa,0xaaaaaaaa,0x00000000,0x00000000,0xaaaaaaaa,0xaaaaaaaa,];
    test(key[], nonce[], ks[], st[]);
  }
  { //12
    immutable[] key = x"00112233445566778899AABBCCDDEEFF";
    immutable[] nonce = x"0F1E2D3C4B5A6978";
    immutable[] ks = x"29560D280B4528400A8F4B795369FB3A01105599E9F1ED58279CFC9ECE2DC5F99F1C2E52C98238F542A5C0A881D850B615D3ACD9FBDB026E9368565DA50E0D49DD5BE8EF74248B3E251D965D8FCB21E7CFE204D4007806FBEE3CE94C74BFBAD2C11C621BA048147C5CAA94D182CCFF6FD5CF44ADF96E3D68281BB49676AF87E7";
    immutable uint[] st = [0x61707865,0x3120646e,0x79622d36,0x6b206574,0x33221100,0x77665544,0xbbaa9988,0xffeeddcc,0x33221100,0x77665544,0xbbaa9988,0xffeeddcc,0x00000000,0x00000000,0x3c2d1e0f,0x78695a4b,];
    test(key[], nonce[], ks[], st[]);
  }
  { //13
    immutable[] key = x"00112233445566778899AABBCCDDEEFFFFEEDDCCBBAA99887766554433221100";
    immutable[] nonce = x"0F1E2D3C4B5A6978";
    immutable[] ks = x"DB43AD9D1E842D1272E4530E276B3F568F8859B3F7CF6D9D2C74FA53808CB5157A8EBF46AD3DCC4B6C7DADDE131784B0120E0E22F6D5F9FFA7407D4A21B695D9C5DD30BF55612FAB9BDD118920C19816470C7F5DCD42325DBBED8C57A56281C144CB0F03E81B3004624E0650A1CE5AFAF9A7CD8163F6DBD72602257DD96E471E";
    immutable uint[] st = [0x61707865,0x3320646e,0x79622d32,0x6b206574,0x33221100,0x77665544,0xbbaa9988,0xffeeddcc,0xccddeeff,0x8899aabb,0x44556677,0x00112233,0x00000000,0x00000000,0x3c2d1e0f,0x78695a4b,];
    test(key[], nonce[], ks[], st[]);
  }
  { //14
    immutable[] key = x"C46EC1B18CE8A878725A37E780DFB735";
    immutable[] nonce = x"1ADA31D5CF688221";
    immutable[] ks = x"6A870108859F679118F3E205E2A56A6826EF5A60A4102AC8D4770059FCB7C7BAE02F5CE004A6BFBBEA53014DD82107C0AA1C7CE11B7D78F2D50BD3602BBD25940560BB6A84289E0B38F5DD21D6EF6D7737E3EC0FB772DA2C71C2397762E5DBBBF449E3D1639CCBFA3E069C4D871ED6395B22AAF35C8DA6DE2DEC3D77880DA8E8";
    immutable uint[] st = [0x61707865,0x3120646e,0x79622d36,0x6b206574,0xb1c16ec4,0x78a8e88c,0xe7375a72,0x35b7df80,0xb1c16ec4,0x78a8e88c,0xe7375a72,0x35b7df80,0x00000000,0x00000000,0xd531da1a,0x218268cf,];
    test(key[], nonce[], ks[], st[]);
  }
  { //15
    immutable[] key = x"C46EC1B18CE8A878725A37E780DFB7351F68ED2E194C79FBC6AEBEE1A667975D";
    immutable[] nonce = x"1ADA31D5CF688221";
    immutable[] ks = x"838751B42D8DDD8A3D77F48825A2BA752CF4047CB308A5978EF274973BE374C96AD848065871417B08F034E681FE46A93F7D5C61D1306614D4AAF257A7CFF08B16F2FDA170CC18A4B58A2667ED962774AF792A6E7F3C77992540711A7A136D7E8A2F8D3F93816709D45A3FA5F8CE72FDE15BE7B841ACBA3A2ABD557228D9FE4F";
    immutable uint[] st = [0x61707865,0x3320646e,0x79622d32,0x6b206574,0xb1c16ec4,0x78a8e88c,0xe7375a72,0x35b7df80,0x2eed681f,0xfb794c19,0xe1beaec6,0x5d9767a6,0x00000000,0x00000000,0xd531da1a,0x218268cf,];
    test(key[], nonce[], ks[], st[]);
  }

  writeln(count, " tests passed.");
}
