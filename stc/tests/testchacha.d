/*
 * ChaCha20 tester.
 * Copyright (C) 2014 Ketmar Dark // Invisible Vector (ketmar@ketmar.no-ip.org)
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * Get a copy of the GNU GPL from <http://www.gnu.org/licenses/>.
 */
// test vectors from RFC-6229
import std.stdio, std.conv, std.range, std.array, std.algorithm;

import iv.stc.chacha;


uint count = 0;

void test (const(void)[] key, const(void)[] iv, const(void)[] ks, const(uint)[] xst) {
  auto bkey = cast(const(ubyte)[])key;
  auto biv = cast(const(ubyte)[])iv;
  auto bks = cast(const(ubyte)[])ks;
  auto ctx = ChaCha20(bkey, biv);
  {
    auto st = ctx.getState;
    if (st[] != xst[]) {
      import std.stdio;
      writeln("xst.length=", xst.length, "; st.length=", st.length);
      foreach (immutable idx; 0..16) {
        writefln("idx=%s; xst=0x%08x, st=0x%08x", idx, xst[idx], st[idx]);
        assert(xst[idx] == st[idx]);
      }
    }
  }

  foreach (immutable idx, ubyte v; bks) {
    if (ctx.front != v) {
      import std.string : format;
      assert(0, "failed! idx=%s; v=%02X %02X".format(idx, v, ctx.front));
    }
    ctx.popFront();
  }

  //writeln("test ", count, " passed");
  ++count;
}


void main () {
  writeln("testing ChaCha20...");

  { //0
    immutable[] key = x"00000000000000000000000000000000";
    immutable[] nonce = x"0000000000000000";
    immutable[] ks = x"89670952608364FD00B2F90936F031C8E756E15DBA04B8493D00429259B20F46CC04F111246B6C2CE066BE3BFB32D9AA0FDDFBC12123D4B9E44F34DCA05A103F6CD135C2878C832B5896B134F6142A9D4D8D0D8F1026D20A0A81512CBCE6E9758A7143D021978022A384141A80CEA3062F41F67A752E66AD3411984C787E30AD";
    immutable uint[] st = [0x61707865,0x3120646e,0x79622d36,0x6b206574,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,];
    test(key[], nonce[], ks[], st[]);
  }
  { //1
    immutable[] key = x"0000000000000000000000000000000000000000000000000000000000000000";
    immutable[] nonce = x"0000000000000000";
    immutable[] ks = x"76B8E0ADA0F13D90405D6AE55386BD28BDD219B8A08DED1AA836EFCC8B770DC7DA41597C5157488D7724E03FB8D84A376A43B8F41518A11CC387B669B2EE65869F07E7BE5551387A98BA977C732D080DCB0F29A048E3656912C6533E32EE7AED29B721769CE64E43D57133B074D839D531ED1F28510AFB45ACE10A1F4B794D6F";
    immutable uint[] st = [0x61707865,0x3320646e,0x79622d32,0x6b206574,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,];
    test(key[], nonce[], ks[], st[]);
  }
  { //2
    immutable[] key = x"01000000000000000000000000000000";
    immutable[] nonce = x"0000000000000000";
    immutable[] ks = x"AE56060D04F5B597897FF2AF1388DBCEFF5A2A4920335DC17A3CB1B1B10FBE70ECE8F4864D8C7CDF0076453A8291C7DBEB3AA9C9D10E8CA36BE4449376ED7C42FC3D471C34A36FBBF616BC0A0E7C523030D944F43EC3E78DD6A12466547CB4F7B3CEBD0A5005E762E562D1375B7AC44593A991B85D1A60FBA2035DFAA2A642D5";
    immutable uint[] st = [0x61707865,0x3120646e,0x79622d36,0x6b206574,0x00000001,0x00000000,0x00000000,0x00000000,0x00000001,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,];
    test(key[], nonce[], ks[], st[]);
  }
  { //3
    immutable[] key = x"0100000000000000000000000000000000000000000000000000000000000000";
    immutable[] nonce = x"0000000000000000";
    immutable[] ks = x"C5D30A7CE1EC119378C84F487D775A8542F13ECE238A9455E8229E888DE85BBD29EB63D0A17A5B999B52DA22BE4023EB07620A54F6FA6AD8737B71EB0464DAC010F656E6D1FD55053E50C4875C9930A33F6D0263BD14DFD6AB8C70521C19338B2308B95CF8D0BB7D202D2102780EA3528F1CB48560F76B20F382B942500FCEAC";
    immutable uint[] st = [0x61707865,0x3320646e,0x79622d32,0x6b206574,0x00000001,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,];
    test(key[], nonce[], ks[], st[]);
  }
  { //4
    immutable[] key = x"00000000000000000000000000000000";
    immutable[] nonce = x"0100000000000000";
    immutable[] ks = x"1663879EB3F2C9949E2388CAA343D361BB132771245AE6D027CA9CB010DC1FA7178DC41F8278BC1F64B3F12769A24097F40D63A86366BDB36AC08ABE60C07FE8B057375C89144408CC744624F69F7F4CCBD93366C92FC4DFCADA65F1B959D8C64DFC50DE711FB46416C2553CC60F21BBFD006491CB17888B4FB3521C4FDD8745";
    immutable uint[] st = [0x61707865,0x3120646e,0x79622d36,0x6b206574,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000001,0x00000000,];
    test(key[], nonce[], ks[], st[]);
  }
  { //5
    immutable[] key = x"0000000000000000000000000000000000000000000000000000000000000000";
    immutable[] nonce = x"0100000000000000";
    immutable[] ks = x"EF3FDFD6C61578FBF5CF35BD3DD33B8009631634D21E42AC33960BD138E50D32111E4CAF237EE53CA8AD6426194A88545DDC497A0B466E7D6BBDB0041B2F586B5305E5E44AFF19B235936144675EFBE4409EB7E8E5F1430F5F5836AEB49BB5328B017C4B9DC11F8A03863FA803DC71D5726B2B6B31AA32708AFE5AF1D6B69058";
    immutable uint[] st = [0x61707865,0x3320646e,0x79622d32,0x6b206574,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000001,0x00000000,];
    test(key[], nonce[], ks[], st[]);
  }
  { //6
    immutable[] key = x"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF";
    immutable[] nonce = x"FFFFFFFFFFFFFFFF";
    immutable[] ks = x"992947C3966126A0E660A3E95DB048DE091FB9E0185B1E41E41015BB7EE50150399E4760B262F9D53F26D8DD19E56F5C506AE0C3619FA67FB0C408106D0203EE40EA3CFA61FA32A2FDA8D1238A2135D9D4178775240F99007064A6A7F0C731B67C227C52EF796B6BED9F9059BA0614BCF6DD6E38917F3B150E576375BE50ED67";
    immutable uint[] st = [0x61707865,0x3120646e,0x79622d36,0x6b206574,0xffffffff,0xffffffff,0xffffffff,0xffffffff,0xffffffff,0xffffffff,0xffffffff,0xffffffff,0x00000000,0x00000000,0xffffffff,0xffffffff,];
    test(key[], nonce[], ks[], st[]);
  }
  { //7
    immutable[] key = x"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF";
    immutable[] nonce = x"FFFFFFFFFFFFFFFF";
    immutable[] ks = x"D9BF3F6BCE6ED0B54254557767FB57443DD4778911B606055C39CC25E674B8363FEABC57FDE54F790C52C8AE43240B79D49042B777BFD6CB80E931270B7F50EB5BAC2ACD86A836C5DC98C116C1217EC31D3A63A9451319F097F3B4D6DAB0778719477D24D24B403A12241D7CCA064F790F1D51CCAFF6B1667D4BBCA1958C4306";
    immutable uint[] st = [0x61707865,0x3320646e,0x79622d32,0x6b206574,0xffffffff,0xffffffff,0xffffffff,0xffffffff,0xffffffff,0xffffffff,0xffffffff,0xffffffff,0x00000000,0x00000000,0xffffffff,0xffffffff,];
    test(key[], nonce[], ks[], st[]);
  }
  { //8
    immutable[] key = x"55555555555555555555555555555555";
    immutable[] nonce = x"5555555555555555";
    immutable[] ks = x"357D7D94F966778F5815A2051DCB04133B26B0EAD9F57DD09927837BC3067E4B6BF299AD81F7F50C8DA83C7810BFC17BB6F4813AB6C326957045FD3FD5E19915EC744A6B9BF8CBDCB36D8B6A5499C68A08EF7BE6CC1E93F2F5BCD2CAD4E47C18A3E5D94B5666382C6D130D822DD56AACB0F8195278E7B292495F09868DDF12CC";
    immutable uint[] st = [0x61707865,0x3120646e,0x79622d36,0x6b206574,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x00000000,0x00000000,0x55555555,0x55555555,];
    test(key[], nonce[], ks[], st[]);
  }
  { //9
    immutable[] key = x"5555555555555555555555555555555555555555555555555555555555555555";
    immutable[] nonce = x"5555555555555555";
    immutable[] ks = x"BEA9411AA453C5434A5AE8C92862F564396855A9EA6E22D6D3B50AE1B3663311A4A3606C671D605CE16C3AECE8E61EA145C59775017BEE2FA6F88AFC758069F7E0B8F676E644216F4D2A3422D7FA36C6C4931ACA950E9DA42788E6D0B6D1CD838EF652E97B145B14871EAE6C6804C7004DB5AC2FCE4C68C726D004B10FCABA86";
    immutable uint[] st = [0x61707865,0x3320646e,0x79622d32,0x6b206574,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x55555555,0x00000000,0x00000000,0x55555555,0x55555555,];
    test(key[], nonce[], ks[], st[]);
  }
  { //10
    immutable[] key = x"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";
    immutable[] nonce = x"AAAAAAAAAAAAAAAA";
    immutable[] ks = x"FC79ACBD58526103862776AAB20F3B7D8D3149B2FAB65766299316B6E5B16684DE5DE548C1B7D083EFD9E3052319E0C6254141DA04A6586DF800F64D46B01C871F05BC67E07628EBE6F6865A2177E0B66A558AA7CC1E8FF1A98D27F7071F8335EFCE4537BB0EF7B573B32F32765F29007DA53BBA62E7A44D006F41EB28FE15D6";
    immutable uint[] st = [0x61707865,0x3120646e,0x79622d36,0x6b206574,0xaaaaaaaa,0xaaaaaaaa,0xaaaaaaaa,0xaaaaaaaa,0xaaaaaaaa,0xaaaaaaaa,0xaaaaaaaa,0xaaaaaaaa,0x00000000,0x00000000,0xaaaaaaaa,0xaaaaaaaa,];
    test(key[], nonce[], ks[], st[]);
  }
  { //11
    immutable[] key = x"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";
    immutable[] nonce = x"AAAAAAAAAAAAAAAA";
    immutable[] ks = x"9AA2A9F656EFDE5AA7591C5FED4B35AEA2895DEC7CB4543B9E9F21F5E7BCBCF3C43C748A970888F8248393A09D43E0B7E164BC4D0B0FB240A2D72115C480890672184489440545D021D97EF6B693DFE5B2C132D47E6F041C9063651F96B623E62A11999A23B6F7C461B2153026AD5E866A2E597ED07B8401DEC63A0934C6B2A9";
    immutable uint[] st = [0x61707865,0x3320646e,0x79622d32,0x6b206574,0xaaaaaaaa,0xaaaaaaaa,0xaaaaaaaa,0xaaaaaaaa,0xaaaaaaaa,0xaaaaaaaa,0xaaaaaaaa,0xaaaaaaaa,0x00000000,0x00000000,0xaaaaaaaa,0xaaaaaaaa,];
    test(key[], nonce[], ks[], st[]);
  }
  { //12
    immutable[] key = x"00112233445566778899AABBCCDDEEFF";
    immutable[] nonce = x"0F1E2D3C4B5A6978";
    immutable[] ks = x"D1ABF630467EB4F67F1CFB47CD626AAE8AFEDBBE4FF8FC5FE9CFAE307E74ED451F1404425AD2B54569D5F18148939971ABB8FAFC88CE4AC7FE1C3D1F7A1EB7CAE76CA87B61A9713541497760DD9AE059350CAD0DCEDFAA80A883119A1A6F987FD1CE91FD8EE0828034B411200A9745A285554475D12AFC04887FEF3516D12A2C";
    immutable uint[] st = [0x61707865,0x3120646e,0x79622d36,0x6b206574,0x33221100,0x77665544,0xbbaa9988,0xffeeddcc,0x33221100,0x77665544,0xbbaa9988,0xffeeddcc,0x00000000,0x00000000,0x3c2d1e0f,0x78695a4b,];
    test(key[], nonce[], ks[], st[]);
  }
  { //13
    immutable[] key = x"00112233445566778899AABBCCDDEEFFFFEEDDCCBBAA99887766554433221100";
    immutable[] nonce = x"0F1E2D3C4B5A6978";
    immutable[] ks = x"9FADF409C00811D00431D67EFBD88FBA59218D5D6708B1D685863FABBB0E961EEA480FD6FB532BFD494B2151015057423AB60A63FE4F55F7A212E2167CCAB931FBFD29CF7BC1D279EDDF25DD316BB8843D6EDEE0BD1EF121D12FA17CBC2C574CCCAB5E275167B08BD686F8A09DF87EC3FFB35361B94EBFA13FEC0E4889D18DA5";
    immutable uint[] st = [0x61707865,0x3320646e,0x79622d32,0x6b206574,0x33221100,0x77665544,0xbbaa9988,0xffeeddcc,0xccddeeff,0x8899aabb,0x44556677,0x00112233,0x00000000,0x00000000,0x3c2d1e0f,0x78695a4b,];
    test(key[], nonce[], ks[], st[]);
  }
  { //14
    immutable[] key = x"C46EC1B18CE8A878725A37E780DFB735";
    immutable[] nonce = x"1ADA31D5CF688221";
    immutable[] ks = x"826ABDD84460E2E9349F0EF4AF5B179B426E4B2D109A9C5BB44000AE51BEA90A496BEEEF62A76850FF3F0402C4DDC99F6DB07F151C1C0DFAC2E56565D62896255B23132E7B469C7BFB88FA95D44CA5AE3E45E848A4108E98BAD7A9EB15512784A6A9E6E591DCE674120ACAF9040FF50FF3AC30CCFB5E14204F5E4268B90A8804";
    immutable uint[] st = [0x61707865,0x3120646e,0x79622d36,0x6b206574,0xb1c16ec4,0x78a8e88c,0xe7375a72,0x35b7df80,0xb1c16ec4,0x78a8e88c,0xe7375a72,0x35b7df80,0x00000000,0x00000000,0xd531da1a,0x218268cf,];
    test(key[], nonce[], ks[], st[]);
  }
  { //15
    immutable[] key = x"C46EC1B18CE8A878725A37E780DFB7351F68ED2E194C79FBC6AEBEE1A667975D";
    immutable[] nonce = x"1ADA31D5CF688221";
    immutable[] ks = x"F63A89B75C2271F9368816542BA52F06ED49241792302B00B5E8F80AE9A473AFC25B218F519AF0FDD406362E8D69DE7F54C604A6E00F353F110F771BDCA8AB92E5FBC34E60A1D9A9DB17345B0A402736853BF910B060BDF1F897B6290F01D138AE2C4C90225BA9EA14D518F55929DEA098CA7A6CCFE61227053C84E49A4A3332";
    immutable uint[] st = [0x61707865,0x3320646e,0x79622d32,0x6b206574,0xb1c16ec4,0x78a8e88c,0xe7375a72,0x35b7df80,0x2eed681f,0xfb794c19,0xe1beaec6,0x5d9767a6,0x00000000,0x00000000,0xd531da1a,0x218268cf,];
    test(key[], nonce[], ks[], st[]);
  }

  writeln(count, " tests passed.");
}
